<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CCM License Admin</title>
    <link rel="stylesheet" href="{{ request.url_for('static', path='admin.css') }}" />
  </head>
  <body>
    <div class="bg-shape bg-shape-a"></div>
    <div class="bg-shape bg-shape-b"></div>
    <main class="shell">
      <header class="hero">
        <h1>CCM License Admin</h1>
        <p>Token TTL: <strong>{{ token_ttl_seconds }}</strong> sec</p>
        <p class="mono">DB: {{ db_path }}</p>
      </header>
      <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

      <section class="panel panel-create">
        <h2>Create License</h2>
        <form method="post" action="{{ create_action }}" class="create-form">
          <label>
            Days
            <input type="number" name="days" min="1" required />
          </label>
          <label>
            License Key (optional)
            <input type="text" name="key" value="{{ generated_key }}" placeholder="ABCD-EFGH-JKLM" />
          </label>
          <label>
            Note (optional)
            <input type="text" name="note" placeholder="trial, customer name, etc." />
          </label>
          <button type="submit">Create</button>
          <button type="submit" formaction="{{ generate_key_action }}" formnovalidate class="secondary">Generate Key</button>
        </form>
      </section>

      <section class="panel panel-list">
        <div class="panel-title">
          <h2>Licenses</h2>
          <span id="licenses-total">{{ licenses|length }} total</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>License</th>
                <th>Status</th>
                <th>Issued</th>
                <th>Expires</th>
                <th>Remaining Time</th>
                <th>Note</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="licenses-tbody">
              {% if licenses %}
                {% for item in licenses %}
                <tr>
                  <td class="mono">{{ item.license_key }}</td>
                  <td>
                    <span class="badge badge-{{ item.display_status }}">
                      {{ item.display_status }}
                    </span>
                  </td>
                  <td class="mono">{{ item.issued_at }}</td>
                  <td class="mono">{{ item.license_expires_at }}</td>
                  <td>
                    {% if item.is_expired %}
                      <span class="expired">expired</span>
                    {% else %}
                      {{ item.remaining_time_label }}
                    {% endif %}
                  </td>
                  <td>{{ item.note or "-" }}</td>
                  <td>
                    {% if item.action_mode == "disable" %}
                    <form method="post" action="{{ item.disable_action }}" class="action-form">
                      <button type="submit" class="danger">Disable</button>
                    </form>
                    {% else %}
                    <form
                      method="post"
                      action="{{ item.enable_action }}"
                      class="action-form"
                      data-requires-duration="{{ 1 if item.requires_duration else 0 }}"
                      data-days-selected="0"
                    >
                      {% if item.requires_duration %}
                      <span class="duration-picker" hidden>
                        <input
                          type="number"
                          name="days"
                          min="1"
                          value="{{ item.duration_days }}"
                          class="duration-input"
                          title="Renew duration (days)"
                        />
                        <span class="duration-suffix">days</span>
                      </span>
                      {% endif %}
                      <button type="submit" class="success">Enable</button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
              <tr>
                <td colspan="7" class="empty">No licenses yet.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
    <script>
      const licensesEndpoint = "{{ request.url_for('admin_list_licenses') }}";
      const refreshIntervalMs = 1000;
      const licensesTableBody = document.getElementById("licenses-tbody");
      const licensesTotal = document.getElementById("licenses-total");
      const toastStack = document.getElementById("toast-stack");
      const initialMessage = {{ message|tojson }};
      const initialError = {{ error|tojson }};
      let refreshInFlight = false;

      function showToast(text, variant) {
        if (!text || !toastStack) {
          return;
        }

        const toast = document.createElement("div");
        toast.className = `toast toast-${variant}`;

        const body = document.createElement("div");
        body.className = "toast-body";
        body.textContent = text;
        toast.appendChild(body);

        const closeButton = document.createElement("button");
        closeButton.type = "button";
        closeButton.className = "toast-close";
        closeButton.setAttribute("aria-label", "Close notification");
        closeButton.textContent = "x";
        closeButton.addEventListener("click", () => {
          toast.classList.remove("show");
          window.setTimeout(() => toast.remove(), 200);
        });
        toast.appendChild(closeButton);

        toastStack.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));

        window.setTimeout(() => {
          toast.classList.remove("show");
          window.setTimeout(() => toast.remove(), 200);
        }, 4200);
      }

      function createCell(textValue, className = "") {
        const cell = document.createElement("td");
        if (className) {
          cell.className = className;
        }
        cell.textContent = textValue;
        return cell;
      }

      function buildActionCell(item) {
        const actionCell = document.createElement("td");
        const form = document.createElement("form");
        form.method = "post";
        form.className = "action-form";

        if (item.action_mode === "disable") {
          form.action = item.disable_action;
          const button = document.createElement("button");
          button.type = "submit";
          button.className = "danger";
          button.textContent = "Disable";
          form.appendChild(button);
        } else {
          form.action = item.enable_action;
          form.dataset.requiresDuration = item.requires_duration ? "1" : "0";
          form.dataset.daysSelected = "0";
          if (item.requires_duration) {
            const durationPicker = document.createElement("span");
            durationPicker.className = "duration-picker";
            durationPicker.hidden = true;

            const daysInput = document.createElement("input");
            daysInput.type = "number";
            daysInput.name = "days";
            daysInput.min = "1";
            daysInput.value = String(item.duration_days);
            daysInput.className = "duration-input";
            daysInput.title = "Renew duration (days)";
            durationPicker.appendChild(daysInput);

            const suffix = document.createElement("span");
            suffix.className = "duration-suffix";
            suffix.textContent = "days";
            durationPicker.appendChild(suffix);
            form.appendChild(durationPicker);
          }

          const button = document.createElement("button");
          button.type = "submit";
          button.className = "success";
          button.textContent = "Enable";
          form.appendChild(button);
        }

        actionCell.appendChild(form);
        return actionCell;
      }

      function buildRow(item) {
        const row = document.createElement("tr");
        row.appendChild(createCell(item.license_key, "mono"));

        const statusCell = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = `badge badge-${item.display_status}`;
        badge.textContent = item.display_status;
        statusCell.appendChild(badge);
        row.appendChild(statusCell);

        row.appendChild(createCell(item.issued_at, "mono"));
        row.appendChild(createCell(item.license_expires_at, "mono"));

        const remainingCell = document.createElement("td");
        if (item.is_expired) {
          const expired = document.createElement("span");
          expired.className = "expired";
          expired.textContent = "expired";
          remainingCell.appendChild(expired);
        } else {
          remainingCell.textContent = item.remaining_time_label;
        }
        row.appendChild(remainingCell);

        row.appendChild(createCell(item.note || "-"));
        row.appendChild(buildActionCell(item));
        return row;
      }

      function buildEmptyRow() {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 7;
        cell.className = "empty";
        cell.textContent = "No licenses yet.";
        row.appendChild(cell);
        return row;
      }

      function openDurationPicker(form) {
        const picker = form.querySelector(".duration-picker");
        const daysInput = form.querySelector("input[name='days']");
        if (!picker || !daysInput) {
          return;
        }

        picker.hidden = false;
        form.classList.add("duration-open");
        daysInput.focus();
        daysInput.select();
      }

      function closeDurationPicker(form) {
        const picker = form.querySelector(".duration-picker");
        if (!picker) {
          return;
        }

        picker.hidden = true;
        form.classList.remove("duration-open");
      }

      function normalizeDurationValue(form) {
        const daysInput = form.querySelector("input[name='days']");
        if (!daysInput) {
          return null;
        }

        const parsed = Number.parseInt(daysInput.value, 10);
        if (!Number.isFinite(parsed) || parsed < 1) {
          return null;
        }

        daysInput.value = String(parsed);
        return parsed;
      }

      licensesTableBody.addEventListener("submit", (event) => {
        const form = event.target;
        if (!(form instanceof HTMLFormElement)) {
          return;
        }
        if (form.dataset.requiresDuration !== "1") {
          return;
        }

        const selectedDays = normalizeDurationValue(form);
        if (form.dataset.daysSelected === "1" && selectedDays !== null) {
          return;
        }

        event.preventDefault();
        openDurationPicker(form);
      });

      licensesTableBody.addEventListener("change", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement) || target.name !== "days") {
          return;
        }

        const form = target.form;
        if (!(form instanceof HTMLFormElement) || form.dataset.requiresDuration !== "1") {
          return;
        }

        const selectedDays = normalizeDurationValue(form);
        if (selectedDays === null) {
          return;
        }

        form.dataset.daysSelected = "1";
        closeDurationPicker(form);
        form.requestSubmit();
      });

      async function refreshLicenses() {
        if (refreshInFlight) {
          return;
        }
        if (licensesTableBody.contains(document.activeElement)) {
          return;
        }
        refreshInFlight = true;

        try {
          const response = await fetch(licensesEndpoint, {
            method: "GET",
            cache: "no-store",
            credentials: "same-origin",
          });
          if (!response.ok) {
            return;
          }

          const payload = await response.json();
          const rows = Array.isArray(payload.licenses) ? payload.licenses : [];
          const fragment = document.createDocumentFragment();

          if (rows.length === 0) {
            fragment.appendChild(buildEmptyRow());
          } else {
            rows.forEach((item) => fragment.appendChild(buildRow(item)));
          }

          licensesTableBody.replaceChildren(fragment);
          licensesTotal.textContent = `${rows.length} total`;
        } catch (_) {
          // Keep current table state if refresh fails.
        } finally {
          refreshInFlight = false;
        }
      }

      showToast(initialMessage, "success");
      showToast(initialError, "error");
      window.setInterval(refreshLicenses, refreshIntervalMs);
    </script>
  </body>
</html>
