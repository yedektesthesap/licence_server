<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CCM License Admin</title>
    <link rel="stylesheet" href="{{ request.url_for('static', path='admin.css') }}" />
  </head>
  <body>
    <div class="bg-shape bg-shape-a"></div>
    <div class="bg-shape bg-shape-b"></div>
    <main class="shell">
      <header class="hero">
        <h1>CCM License Admin</h1>
        <p>Token TTL: <strong>{{ token_ttl_seconds }}</strong> sec</p>
        <p class="mono">DB: {{ db_path }}</p>
      </header>
      <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

      <section class="panel panel-create">
        <h2>Create License</h2>
        <form method="post" action="{{ create_action }}" class="create-form">
          <label>
            Days
            <input type="number" name="days" min="1" required />
          </label>
          <label>
            License Key (optional)
            <input type="text" name="key" value="{{ generated_key }}" placeholder="ABCD-EFGH-JKLM" />
          </label>
          <label>
            Note (optional)
            <input type="text" name="note" placeholder="trial, customer name, etc." />
          </label>
          <button type="submit">Create</button>
          <button type="submit" formaction="{{ generate_key_action }}" formnovalidate class="secondary">Generate Key</button>
        </form>
      </section>

      <section class="panel panel-list">
        <div class="panel-title">
          <h2>Licenses</h2>
          <span id="licenses-total">{{ licenses|length }} total</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>License</th>
                <th>Status</th>
                <th>Issued</th>
                <th>Expires</th>
                <th>Remaining Time</th>
                <th>Note</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="licenses-tbody">
              {% if licenses %}
                {% for item in licenses %}
                <tr>
                  <td class="mono">{{ item.license_key }}</td>
                  <td>
                    <span class="badge badge-{{ item.display_status }}">
                      {{ item.display_status }}
                    </span>
                  </td>
                  <td class="mono">{{ item.issued_at }}</td>
                  <td class="mono">{{ item.license_expires_at }}</td>
                  <td
                    class="remaining-time-cell"
                    data-license-key="{{ item.license_key }}"
                    data-update-action="{{ item.update_remaining_action }}"
                    data-default-days="{{ item.duration_days }}"
                  >
                    <button
                      type="button"
                      class="remaining-time-trigger{% if item.is_expired %} is-expired{% endif %}"
                      title="Set remaining days"
                    >
                      {% if item.is_expired %}
                        expired
                      {% else %}
                        {{ item.remaining_time_label }}
                      {% endif %}
                    </button>
                  </td>
                  <td>{{ item.note or "-" }}</td>
                  <td>
                    {% if item.action_mode == "disable" %}
                    <form method="post" action="{{ item.disable_action }}" class="action-form">
                      <button type="submit" class="danger">Disable</button>
                    </form>
                    {% else %}
                    <form
                      method="post"
                      action="{{ item.enable_action }}"
                      class="action-form"
                      data-requires-duration="{{ 1 if item.requires_duration else 0 }}"
                    >
                      <button type="submit" class="success">Enable</button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
              <tr>
                <td colspan="7" class="empty">No licenses yet.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
    <script>
      const licensesEndpoint = "{{ request.url_for('admin_list_licenses') }}";
      const refreshIntervalMs = 1000;
      const licensesTableBody = document.getElementById("licenses-tbody");
      const licensesTotal = document.getElementById("licenses-total");
      const toastStack = document.getElementById("toast-stack");
      const initialMessage = {{ message|tojson }};
      const initialError = {{ error|tojson }};
      let refreshInFlight = false;

      function showToast(text, variant) {
        if (!text || !toastStack) {
          return;
        }

        const toast = document.createElement("div");
        toast.className = `toast toast-${variant}`;

        const body = document.createElement("div");
        body.className = "toast-body";
        body.textContent = text;
        toast.appendChild(body);

        const closeButton = document.createElement("button");
        closeButton.type = "button";
        closeButton.className = "toast-close";
        closeButton.setAttribute("aria-label", "Close notification");
        closeButton.textContent = "x";
        closeButton.addEventListener("click", () => {
          toast.classList.remove("show");
          window.setTimeout(() => toast.remove(), 200);
        });
        toast.appendChild(closeButton);

        toastStack.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));

        window.setTimeout(() => {
          toast.classList.remove("show");
          window.setTimeout(() => toast.remove(), 200);
        }, 4200);
      }

      function createCell(textValue, className = "") {
        const cell = document.createElement("td");
        if (className) {
          cell.className = className;
        }
        cell.textContent = textValue;
        return cell;
      }

      function buildActionCell(item) {
        const actionCell = document.createElement("td");
        const form = document.createElement("form");
        form.method = "post";
        form.className = "action-form";

        if (item.action_mode === "disable") {
          form.action = item.disable_action;
          const button = document.createElement("button");
          button.type = "submit";
          button.className = "danger";
          button.textContent = "Disable";
          form.appendChild(button);
        } else {
          form.action = item.enable_action;
          form.dataset.requiresDuration = item.requires_duration ? "1" : "0";

          const button = document.createElement("button");
          button.type = "submit";
          button.className = "success";
          button.textContent = "Enable";
          form.appendChild(button);
        }

        actionCell.appendChild(form);
        return actionCell;
      }

      function buildRemainingCell(item) {
        const remainingCell = document.createElement("td");
        remainingCell.className = "remaining-time-cell";
        remainingCell.dataset.licenseKey = item.license_key;
        remainingCell.dataset.updateAction = item.update_remaining_action;
        remainingCell.dataset.defaultDays = String(item.duration_days);

        const trigger = document.createElement("button");
        trigger.type = "button";
        trigger.className = "remaining-time-trigger";
        trigger.title = "Set remaining days";

        if (item.is_expired) {
          trigger.classList.add("is-expired");
          trigger.textContent = "expired";
        } else {
          trigger.textContent = item.remaining_time_label;
        }

        remainingCell.appendChild(trigger);
        return remainingCell;
      }

      function buildRow(item) {
        const row = document.createElement("tr");
        row.appendChild(createCell(item.license_key, "mono"));

        const statusCell = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = `badge badge-${item.display_status}`;
        badge.textContent = item.display_status;
        statusCell.appendChild(badge);
        row.appendChild(statusCell);

        row.appendChild(createCell(item.issued_at, "mono"));
        row.appendChild(createCell(item.license_expires_at, "mono"));
        row.appendChild(buildRemainingCell(item));

        row.appendChild(createCell(item.note || "-"));
        row.appendChild(buildActionCell(item));
        return row;
      }

      function buildEmptyRow() {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 7;
        cell.className = "empty";
        cell.textContent = "No licenses yet.";
        row.appendChild(cell);
        return row;
      }

      function parseDays(rawValue) {
        const parsed = Number.parseInt(String(rawValue), 10);
        if (!Number.isFinite(parsed) || parsed < 1) {
          return null;
        }
        return parsed;
      }

      async function saveRemainingDays(cell, days) {
        const updateAction = cell.dataset.updateAction;
        const licenseKey = cell.dataset.licenseKey || "";
        if (!updateAction) {
          showToast("Remaining time update action is missing.", "error");
          return false;
        }

        const payload = new FormData();
        payload.append("days", String(days));

        try {
          const response = await fetch(updateAction, {
            method: "POST",
            credentials: "same-origin",
            body: payload,
          });
          const data = await response.json().catch(() => ({}));

          if (!response.ok || data.ok === false) {
            showToast(data.error || "Remaining time update failed.", "error");
            return false;
          }

          cell.dataset.defaultDays = String(days);
          showToast(data.message || `Remaining time updated: ${licenseKey}`, "success");
          await refreshLicenses();
          return true;
        } catch (_) {
          showToast("Remaining time update failed.", "error");
          return false;
        }
      }

      function openRemainingEditor(cell) {
        if (cell.dataset.editing === "1") {
          return;
        }

        const trigger = cell.querySelector(".remaining-time-trigger");
        if (!(trigger instanceof HTMLButtonElement)) {
          return;
        }

        const defaultDays = parseDays(cell.dataset.defaultDays) || 1;
        cell.dataset.editing = "1";
        trigger.hidden = true;

        const form = document.createElement("form");
        form.className = "remaining-edit-form";

        const input = document.createElement("input");
        input.type = "number";
        input.name = "days";
        input.min = "1";
        input.required = true;
        input.value = String(defaultDays);
        input.className = "remaining-edit-input";
        input.setAttribute("aria-label", "Remaining days");
        form.appendChild(input);

        const suffix = document.createElement("span");
        suffix.className = "duration-suffix";
        suffix.textContent = "days";
        form.appendChild(suffix);

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          const days = parseDays(input.value);
          if (days === null) {
            showToast("Days must be >= 1.", "error");
            input.focus();
            input.select();
            return;
          }

          const ok = await saveRemainingDays(cell, days);
          if (!ok) {
            input.focus();
            input.select();
          }
        });

        input.addEventListener("keydown", (event) => {
          if (event.key !== "Escape") {
            return;
          }

          event.preventDefault();
          form.remove();
          trigger.hidden = false;
          cell.dataset.editing = "0";
        });

        cell.appendChild(form);
        input.focus();
        input.select();
      }

      licensesTableBody.addEventListener("submit", (event) => {
        const form = event.target;
        if (!(form instanceof HTMLFormElement) || !form.classList.contains("action-form")) {
          return;
        }
        if (form.dataset.requiresDuration !== "1") {
          return;
        }

        event.preventDefault();
        showToast("Lisans expired. Once Remaining Time sutununu guncelleyin.", "error");
      });

      licensesTableBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }

        const trigger = target.closest(".remaining-time-trigger");
        if (!(trigger instanceof HTMLButtonElement)) {
          return;
        }

        const cell = trigger.closest(".remaining-time-cell");
        if (!(cell instanceof HTMLTableCellElement)) {
          return;
        }

        openRemainingEditor(cell);
      });

      async function refreshLicenses() {
        if (refreshInFlight) {
          return;
        }
        if (licensesTableBody.contains(document.activeElement)) {
          return;
        }
        refreshInFlight = true;

        try {
          const response = await fetch(licensesEndpoint, {
            method: "GET",
            cache: "no-store",
            credentials: "same-origin",
          });
          if (!response.ok) {
            return;
          }

          const payload = await response.json();
          const rows = Array.isArray(payload.licenses) ? payload.licenses : [];
          const fragment = document.createDocumentFragment();

          if (rows.length === 0) {
            fragment.appendChild(buildEmptyRow());
          } else {
            rows.forEach((item) => fragment.appendChild(buildRow(item)));
          }

          licensesTableBody.replaceChildren(fragment);
          licensesTotal.textContent = `${rows.length} total`;
        } catch (_) {
          // Keep current table state if refresh fails.
        } finally {
          refreshInFlight = false;
        }
      }

      showToast(initialMessage, "success");
      showToast(initialError, "error");
      window.setInterval(refreshLicenses, refreshIntervalMs);
    </script>
  </body>
</html>
